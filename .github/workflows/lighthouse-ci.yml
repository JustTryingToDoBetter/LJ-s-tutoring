# ============================================================================
# LIGHTHOUSE CI WORKFLOW - Performance & SEO Monitoring
# ============================================================================
# 
# PURPOSE:
# Automated performance, SEO, and best practices auditing.
# Catches performance regressions before they reach production.
# Focuses on PERFORMANCE (not correctness - that's QA's job).
# 
# RUNS ON:
# - Pull requests (all commits) - ONLY mode that enforces thresholds
# - Manual trigger via Actions tab
# - NOT on every push to main (too frequent, use QA for that)
# 
# CHECKS PERFORMED:
# 1. Lighthouse performance metrics
# 2. SEO best practices
# 3. PWA readiness
# 4. Best practices compliance
# 
# OUTPUTS:
# - Lighthouse HTML reports (downloadable)
# - PR status check (enforces performance budgets)
# - PR comment with score summary
# ============================================================================

name: Lighthouse CI

on:
  pull_request:       # Only run on PRs (most important)
  workflow_dispatch:  # Allow manual trigger
  # Removed: push to main (redundant - PRs already tested)

concurrency:
  group: lighthouse-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        env:
          PUPPETEER_SKIP_DOWNLOAD: "true"
        run: npm ci

      - name: Install Chromium

        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium
          echo "CHROME_PATH=$(which chromium-browser || which chromium)" >> $GITHUB_ENV

      # ========================================================================
      # BUILD SITE
      # ========================================================================
      - name: Build site
        run: npm run build

      # ========================================================================
      # START SERVER
      # ========================================================================
      - name: Start static server
        run: |
          npx http-server dist -p 8080 -c-1 --silent &
          npx wait-on --timeout 60000 http://localhost:8080/

      # ========================================================================
      # RUN LIGHTHOUSE CI
      # ========================================================================
      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          npx lhci autorun --config=./lighthouserc.js
          echo "status=passed" >> $GITHUB_OUTPUT

      # ========================================================================
      # UPLOAD LIGHTHOUSE REPORTS
      # ========================================================================
      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30

      # ========================================================================
      # PARSE LIGHTHOUSE RESULTS
      # ========================================================================
      - name: Parse Lighthouse results
        if: always()
        id: parse
        run: |
          # Find the most recent manifest file
          MANIFEST=$(find .lighthouseci -name "manifest.json" | head -n 1)
          
          if [ -f "$MANIFEST" ]; then
            # Extract scores from the first URL's latest run
            REPORT=$(jq -r '.[0].jsonPath' "$MANIFEST" | head -n 1)
            
            if [ -f "$REPORT" ]; then
              PERF=$(jq -r '.categories.performance.score * 100 | floor' "$REPORT")
              A11Y=$(jq -r '.categories.accessibility.score * 100 | floor' "$REPORT")
              PRACTICES=$(jq -r '.categories["best-practices"].score * 100 | floor' "$REPORT")
              SEO=$(jq -r '.categories.seo.score * 100 | floor' "$REPORT")
              
              echo "performance=$PERF" >> $GITHUB_OUTPUT
              echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
              echo "best_practices=$PRACTICES" >> $GITHUB_OUTPUT
              echo "seo=$SEO" >> $GITHUB_OUTPUT
            else
              echo "No report found"
              echo "performance=0" >> $GITHUB_OUTPUT
              echo "accessibility=0" >> $GITHUB_OUTPUT
              echo "best_practices=0" >> $GITHUB_OUTPUT
              echo "seo=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "No manifest found"
            echo "performance=0" >> $GITHUB_OUTPUT
            echo "accessibility=0" >> $GITHUB_OUTPUT
            echo "best_practices=0" >> $GITHUB_OUTPUT
            echo "seo=0" >> $GITHUB_OUTPUT
          fi

      # ========================================================================
      # CREATE PR COMMENT
      # ========================================================================
      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const perf = '${{ steps.parse.outputs.performance }}';
            const a11y = '${{ steps.parse.outputs.accessibility }}';
            const practices = '${{ steps.parse.outputs.best_practices }}';
            const seo = '${{ steps.parse.outputs.seo }}';
            const status = '${{ steps.lighthouse.outputs.status }}';
            
            const getEmoji = (score) => {
              if (score >= 90) return 'üü¢';
              if (score >= 50) return 'üü†';
              return 'üî¥';
            };
            
            const body = `## ‚ö° Lighthouse Performance Report
            
            | Category | Score |
            |----------|-------|
            | ${getEmoji(perf)} Performance | ${perf}/100 |
            | ${getEmoji(a11y)} Accessibility | ${a11y}/100 |
            | ${getEmoji(practices)} Best Practices | ${practices}/100 |
            | ${getEmoji(seo)} SEO | ${seo}/100 |
            
            ${status === 'passed' 
              ? '‚úÖ **All performance budgets met!**' 
              : '‚ö†Ô∏è **Performance budgets not met.** Download [detailed reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) from artifacts.'}
            
            <details>
            <summary>Score Guide</summary>
            
            - üü¢ 90-100: Good
            - üü† 50-89: Needs improvement
            - üî¥ 0-49: Poor
            </details>
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('## ‚ö° Lighthouse Performance Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ========================================================================
      # FINAL STATUS CHECK
      # ========================================================================
      - name: Check Lighthouse status
        if: always()
        run: |
          if [[ "${{ steps.lighthouse.outputs.status }}" == "failed" ]]; then
            echo "‚ùå Lighthouse checks failed - performance budgets not met"
            exit 1
          else
            echo "‚úÖ Lighthouse checks passed"
          fi

# ============================================================================
# TROUBLESHOOTING
# ============================================================================
# 
# ERROR: "LHCI autorun failed"
# - Download lighthouse-reports artifact from Actions tab
# - Open HTML reports in browser to see detailed metrics
# - Compare scores to thresholds in lighthouserc.js
# - Common fixes:
#   * Optimize images (use WebP, proper sizing)
#   * Minify JS/CSS
#   * Enable caching headers
#   * Lazy load images
#   * Remove unused dependencies
# 
# ERROR: "Cannot parse Lighthouse results"
# - Check if build succeeded
# - Verify lighthouserc.js exists and is valid
# - Check .lighthouseci/ directory was created
# 
# WARNING: "Scores vary between runs"
# - Normal! Lighthouse has ¬±5 point variance
# - We run 3x and use median (configured in lighthouserc.js)
# - Don't chase small fluctuations
# 
# ============================================================================
# PERFORMANCE BUDGETS
# ============================================================================
# 
# Configured in lighthouserc.js:
# - Performance: 75+
# - Accessibility: 90+
# - Best Practices: 90+
# - SEO: 90+
# 
# Adjust thresholds based on your needs, but never lower accessibility below 90.
# 
# ============================================================================
# INTEGRATION WITH QA WORKFLOW
# ============================================================================
# 
# This workflow is COMPLEMENTARY to qa.yml:
# 
# QA Workflow:
# - Validates correctness (HTML, links, a11y compliance)
# - Removed Pa11y (now here in Lighthouse - includes a11y scoring)
# - Runs on every push + PR
# 
# Lighthouse Workflow:
# - Validates performance (speed, optimization, UX)
# - Includes accessibility scoring as part of Lighthouse
# - Runs only on PRs (not every push)
# 
# Both must pass for PR merge.
# 
# ============================================================================
