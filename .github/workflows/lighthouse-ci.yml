# ============================================================================
# LIGHTHOUSE CI WORKFLOW
# ============================================================================
# 
# PURPOSE:
# Automated performance, accessibility, and SEO auditing on every push/PR.
# Catches regressions before they reach production.
# 
# WHEN IT RUNS:
# - Every push to any branch
# - Every pull request (new commits)
# - Can be manually triggered from Actions tab
# 
# WHAT IT DOES:
# 1. Builds the site (npm run build)
# 2. Starts local server
# 3. Runs Lighthouse on multiple pages
# 4. Checks scores against thresholds (lighthouserc.js)
# 5. Uploads reports for review
# 6. Fails if performance/accessibility drops
# 
# HOW IT FITS IN THE SYSTEM:
# - Parallel to QA workflow (can run simultaneously)
# - Uses same build artifacts (dist/)
# - Provides quantitative metrics (QA is qualitative)
# - Enforces performance budgets (constraint)
# ============================================================================

name: Lighthouse CI

# Trigger conditions
on:
  push:
    branches:
      - main # Run on all branches
  pull_request:       # Run on PRs
  workflow_dispatch:  # Allow manual trigger

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Start static server
        run: |
          npx http-server dist -p 8080 -c-1 --silent &
          npx wait-on http://localhost:8080/index.html

      - name: Run Lighthouse CI
        run: npx lhci autorun

      - name: Run Pa11y
        run: npx pa11y-ci
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
# 
# ERROR: "LHCI autorun failed"
# - Click "Run Lighthouse CI" step to see which metric failed
# - Click report URL to see detailed Lighthouse report
# - Compare to thresholds in lighthouserc.js
# - Fix issues and push again
# 
# ERROR: "Cannot start server"
# - Check dist/ directory exists (build step succeeded)
# - Verify lighthouserc.js staticDistDir path is correct
# 
# ERROR: "Timeout waiting for server"
# - Server may be slow to start
# - Increase timeout in lighthouserc.js
# 
# WARNING: "Scores vary between runs"
# - Normal! Lighthouse has inherent variability
# - That's why we run 3x and use median (see lighthouserc.js)
# 
# ============================================================================
# PERFORMANCE TIPS
# ============================================================================
# 
# To speed up this workflow:
# 
# 1. Use npm ci instead of npm install (already doing this)
# 2. Cache node_modules (already doing this via setup-node)
# 3. Reduce numberOfRuns in lighthouserc.js (trade-off: less reliable)
# 4. Test fewer pages (trade-off: less coverage)
# 5. Run on schedule instead of every push (trade-off: slower feedback)
# 
# ============================================================================
# GITHUB SECRETS SETUP
# ============================================================================
# 
# Required Secrets (optional but recommended):
# 
# 1. Go to: Repository → Settings → Secrets and variables → Actions
# 
# 2. Add secrets:
#    - WHATSAPP_NUMBER: Your production WhatsApp number
#    - FORMSPREE_ENDPOINT: Your production Formspree endpoint
#    - CONTACT_EMAIL: Your production email
#    - COUNTDOWN_DATE: Your production countdown date
#    - LHCI_GITHUB_APP_TOKEN: For PR comments (optional)
# 
# Without secrets, workflow uses fallback defaults (safe for testing).
# 
# ============================================================================
# INTEGRATION WITH OTHER WORKFLOWS
# ============================================================================
# 
# This workflow is INDEPENDENT of qa.yml:
# - Both run in parallel
# - Both must pass for PR to be mergeable
# - QA focuses on correctness (valid HTML, working links, a11y compliance)
# - Lighthouse focuses on performance (speed, optimization, UX metrics)
# 
# Together they provide comprehensive quality assurance.
# 
# ============================================================================
