# ============================================================================
# QA WORKFLOW - Code Quality & Accessibility
# ============================================================================
# 
# PURPOSE:
# Validates code quality, HTML standards, links, and accessibility.
# Focuses on CORRECTNESS (not performance - that's Lighthouse's job).
# 
# RUNS ON:
# - Pull requests (all commits)
# - Pushes to main branch
# - Manual trigger via Actions tab
# 
# CHECKS PERFORMED:
# 1. Security audit (npm audit)
# 2. HTML validation (W3C standards)
# 3. Internal link checking
# 4. Accessibility compliance (Pa11y)
# 
# OUTPUTS:
# - Status check (pass/fail for PR mergeability)
# - Uploaded reports (downloadable from Actions tab)
# - PR comment with summary (when failures occur)
# ============================================================================

name: QA

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: qa-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        env:
          PUPPETEER_SKIP_DOWNLOAD: "true"
        run: npm ci

      - name: Install Chromium

        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium
          echo "CHROME_PATH=$(which chromium-browser || which chromium)" >> $GITHUB_ENV

      # ========================================================================
      # SECURITY AUDIT
      # ========================================================================
      - name: Security audit (prod dependencies)
        id: security
        continue-on-error: true
        run: |
          set +e
          npm audit --audit-level=high --omit=dev > security-report.txt 2>&1
          code=$?
          if [ "$code" -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-report.txt
          retention-days: 30

      # ========================================================================
      # BUILD SITE
      # ========================================================================
      - name: Build site
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: dist/
          retention-days: 7

      # ========================================================================
      # START SERVER (for link checking)
      # ========================================================================
      - name: Start static server
        run: |
          npx http-server dist -p 8080 -c-1 --silent &
          npx wait-on http://localhost:8080/ --timeout 30000

      # ========================================================================
      # HTML VALIDATION
      # ========================================================================
      - name: HTML validation
        id: html
        continue-on-error: true
        run: |
          set +e
          npx html-validate "dist/**/*.html" --formatter json > html-validation.json
          code=$?
          if [ "$code" -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Upload HTML validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-validation-report
          path: html-validation.json
          retention-days: 30

      # ========================================================================
      # LINK CHECKING
      # ========================================================================
      - name: Link check (internal)
        id: links
        continue-on-error: true
        run: |
          set +e


          npx linkinator http://localhost:8080 \
            --recurse \
            --timeout 10000 \
            --concurrency 4 \
            --skip "^mailto:|^tel:|^https?:\/\/(?!localhost:8080)" \
            --format json > link-check.json
          code=$?
          if [ "$code" -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Upload link check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: link-check.json
          retention-days: 30

      # ========================================================================
      # ACCESSIBILITY CHECK
      # ========================================================================
      - name: Accessibility check (Pa11y)
        id: a11y
        continue-on-error: true
        env:
          PUPPETEER_EXECUTABLE_PATH: ${{ env.CHROME_PATH }}
        run: |
          set +e
          npx pa11y-ci --json > pa11y-report.json
          code=$?
          if [ "$code" -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: pa11y-report.json
          retention-days: 30


      # ========================================================================
      # SUMMARY COMMENT (on PR)
      # ========================================================================
      - name: Create QA summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const securityStatus = '${{ steps.security.outputs.status }}' || 'failed';
            const htmlStatus = '${{ steps.html.outputs.status }}' || 'failed';
            const linksStatus = '${{ steps.links.outputs.status }}' || 'failed';
            const a11yStatus = '${{ steps.a11y.outputs.status }}' || 'failed';
            
            const statusIcon = (status) => status === 'passed' ? '‚úÖ' : '‚ùå';
            
            const body = `## QA Report
            
            | Check | Status |
            |-------|--------|
            | Security Audit | ${statusIcon(securityStatus)} ${securityStatus} |
            | HTML Validation | ${statusIcon(htmlStatus)} ${htmlStatus} |
            | Link Check | ${statusIcon(linksStatus)} ${linksStatus} |
            | Accessibility | ${statusIcon(a11yStatus)} ${a11yStatus} |
            
            ${securityStatus === 'failed' || htmlStatus === 'failed' || linksStatus === 'failed' || a11yStatus === 'failed' 
              ? '‚ö†Ô∏è **Some checks failed.** Download detailed reports from the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
              : 'üéâ **All QA checks passed!**'}
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('## QA Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ========================================================================
      # FAIL IF ANY CHECK FAILED
      # ========================================================================
      - name: Check all results
        if: always()
        run: |
          if [[ "${{ steps.security.outputs.status }}" == "failed" ]] || \
             [[ "${{ steps.html.outputs.status }}" == "failed" ]] || \
             [[ "${{ steps.links.outputs.status }}" == "failed" ]] || \
             [[ "${{ steps.a11y.outputs.status }}" == "failed" ]]; then
            echo "‚ùå One or more QA checks failed"
            exit 1
          else
            echo "‚úÖ All QA checks passed"
          fi

# ============================================================================
# TROUBLESHOOTING
# ============================================================================
# 
# ERROR: "Security audit failed"
# - Click "Security audit" step to see vulnerable packages
# - Run `npm audit fix` locally and commit
# - If unfixable, document in README and use `npm audit --audit-level=critical`
# 
# ERROR: "HTML validation failed"
# - Download html-validation-report artifact
# - Fix invalid HTML and push
# 
# ERROR: "Link check failed"
# - Download link-check-report artifact
# - Fix broken internal links
# 
# ERROR: "Accessibility check failed"
# - Download accessibility-report artifact
# - Fix a11y issues (missing alt text, poor contrast, etc.)
# 
# ============================================================================
