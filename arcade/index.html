/* ============================================================================
  Project Odysseus — Arcade Controller (Frontend-only)
  - Dark mode shared across pages via localStorage key "po_theme"
  - Mobile menu toggle
  - Arcade tabs -> mounts selected game into #po-stage
  - Daily Voyage CTA -> opens Quick Math first, then Word Voyage (simple loop)
============================================================================ */

(() => {
  "use strict";

  // ---------------------------
  // Theme (shared)
  // ---------------------------
  const THEME_KEY = "po_theme"; // "dark" | "light"
  const root = document.documentElement;

  const setTheme = (mode) => {
    if (mode === "dark") root.classList.add("dark");
    else root.classList.remove("dark");
    try { localStorage.setItem(THEME_KEY, mode); } catch {}
    // Update aria state + icon if present
    const btn = document.getElementById("dark-mode-toggle");
    const icon = document.getElementById("dark-mode-icon");
    if (btn) btn.setAttribute("aria-pressed", mode === "dark" ? "true" : "false");
    if (icon) {
      icon.classList.toggle("fa-moon", mode !== "dark");
      icon.classList.toggle("fa-sun", mode === "dark");
    }
  };

  const initTheme = () => {
    let saved = null;
    try { saved = localStorage.getItem(THEME_KEY); } catch {}
    if (saved === "dark" || saved === "light") {
      setTheme(saved);
      return;
    }
    // Default: follow system preference for first-time users
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    setTheme(prefersDark ? "dark" : "light");
  };

  // ---------------------------
  // Mobile menu
  // ---------------------------
  const initMobileMenu = () => {
    const btn = document.getElementById("mobile-menu-btn");
    const menu = document.getElementById("mobile-menu");
    if (!btn || !menu) return;

    btn.addEventListener("click", () => {
      const expanded = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", expanded ? "false" : "true");
      menu.classList.toggle("open"); // matches your existing CSS behavior
    });
  };

  // ---------------------------
  // Arcade state + mounting
  // ---------------------------
  const STATS_KEY = "po_arcade_profile_v1";
  const getTodaySeed = () => {
    const d = new Date();
    // yyyy-mm-dd (UTC) so it’s stable across timezones
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth() + 1).padStart(2, "0");
    const day = String(d.getUTCDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  };

  const loadProfile = () => {
    try {
      const raw = localStorage.getItem(STATS_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  };

  const saveProfile = (p) => {
    try { localStorage.setItem(STATS_KEY, JSON.stringify(p)); } catch {}
  };

  const defaultProfile = () => ({
    streak: 0,
    completed: 0,
    lastSeed: "",
  });

  const updateStatsUI = (profile) => {
    const s = document.getElementById("po-streak");
    const c = document.getElementById("po-completed");
    const seed = document.getElementById("po-seed");
    if (s) s.textContent = String(profile.streak || 0);
    if (c) c.textContent = String(profile.completed || 0);
    if (seed) seed.textContent = getTodaySeed();
  };

  const bumpDailyStreakIfNeeded = (profile) => {
    const today = getTodaySeed();
    if (profile.lastSeed === today) return profile;

    // If lastSeed is yesterday, streak increments; otherwise resets.
    // We’ll compute yesterday seed in UTC.
    const now = new Date();
    const y = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1));
    const ySeed = `${y.getUTCFullYear()}-${String(y.getUTCMonth() + 1).padStart(2, "0")}-${String(y.getUTCDate()).padStart(2, "0")}`;

    if (profile.lastSeed === ySeed) profile.streak = (profile.streak || 0) + 1;
    else profile.streak = 1;

    profile.lastSeed = today;
    saveProfile(profile);
    return profile;
  };

  const registry = () => (window.PO_ARCADE_GAMES || []);

  const mountGame = (gameId) => {
    const stage = document.getElementById("po-stage");
    if (!stage) return;

    const game = registry().find((g) => g.id === gameId);
    if (!game || typeof game.mount !== "function") {
      stage.innerHTML = `
        <div class="text-center text-gray-500 dark:text-slate-400 py-16">
          <div class="text-4xl mb-4">⚠️</div>
          <p class="font-semibold">Game not found: ${gameId}</p>
          <p class="text-sm mt-2">Confirm the script for this game is included and loaded.</p>
        </div>
      `;
      return;
    }

    // Clear and mount
    stage.innerHTML = "";
    game.mount(stage);
  };

  const setActiveTab = (btn) => {
    const tabs = Array.from(document.querySelectorAll(".po-tab-btn"));
    tabs.forEach((t) => {
      const isActive = t === btn;
      t.setAttribute("aria-selected", isActive ? "true" : "false");

      // Active button style matches your brand
      if (isActive) {
        t.classList.remove("bg-white", "dark:bg-slate-800", "text-brand-dark", "dark:text-white", "border", "border-slate-200", "dark:border-slate-700");
        t.classList.add("bg-brand-dark", "text-white");
      } else {
        t.classList.remove("bg-brand-dark", "text-white");
        t.classList.add("bg-white", "dark:bg-slate-800", "text-brand-dark", "dark:text-white", "border", "border-slate-200", "dark:border-slate-700");
      }
    });
  };

  const initTabs = () => {
    const tabs = Array.from(document.querySelectorAll(".po-tab-btn"));
    if (!tabs.length) return;

    tabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-game");
        if (!id) return;
        setActiveTab(btn);
        mountGame(id);
      });
    });

    // Default to first tab’s game
    const first = tabs[0];
    setActiveTab(first);
    mountGame(first.getAttribute("data-game"));
  };

  // ---------------------------
  // Daily Voyage flow
  // ---------------------------
  const initDailyVoyage = () => {
    const play = document.getElementById("po-play-daily");
    const reset = document.getElementById("po-reset-profile");

    let profile = loadProfile() || defaultProfile();
    profile = bumpDailyStreakIfNeeded(profile);
    updateStatsUI(profile);

    if (play) {
      play.addEventListener("click", () => {
        // Start Quick Math
        const tabs = Array.from(document.querySelectorAll(".po-tab-btn"));
        const qm = tabs.find((t) => t.getAttribute("data-game") === "quickmath");
        if (qm) qm.click();

        // Count “voyage started” as a completion for retention metrics
        profile.completed = (profile.completed || 0) + 1;
        saveProfile(profile);
        updateStatsUI(profile);

        // After a short delay, suggest Word Voyage by switching tab.
        // (No popups. Just a gentle flow.)
        setTimeout(() => {
          const wv = tabs.find((t) => t.getAttribute("data-game") === "wordle");
          if (wv) wv.click();
        }, 1200);
      });
    }

    if (reset) {
      reset.addEventListener("click", () => {
        const fresh = defaultProfile();
        saveProfile(fresh);
        updateStatsUI(fresh);
        // Also scroll user down to the map
        const stage = document.getElementById("po-stage");
        if (stage) stage.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }
  };

  // ---------------------------
  // Theme toggle binding
  // ---------------------------
  const initThemeToggle = () => {
    const btn = document.getElementById("dark-mode-toggle");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const isDark = root.classList.contains("dark");
      setTheme(isDark ? "light" : "dark");
    });
  };

  // ---------------------------
  // Boot
  // ---------------------------
  document.addEventListener("DOMContentLoaded", () => {
    initTheme();
    initThemeToggle();
    initMobileMenu();

    // Important: tabs should init after game scripts load.
    // Because scripts are deferred, by DOMContentLoaded they should be ready.
    initTabs();
    initDailyVoyage();
  });
})();
