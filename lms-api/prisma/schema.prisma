generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TUTOR
}

enum SessionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
}

enum PayPeriodStatus {
  OPEN
  LOCKED
}

enum AdjustmentType {
  BONUS
  CORRECTION
  PENALTY
}

enum AdjustmentStatus {
  DRAFT
  APPROVED
}

enum InvoiceLineType {
  SESSION
  ADJUSTMENT
}

enum PrivacyRequestType {
  ACCESS
  CORRECTION
  DELETION
}

enum PrivacyRequestStatus {
  OPEN
  CLOSED
}

enum PrivacyRequestOutcome {
  FULFILLED
  REJECTED
  ANONYMIZED
  DELETED
  CORRECTED
}

enum PrivacySubjectType {
  TUTOR
  STUDENT
}

model User {
  id             String        @id @default(uuid()) @db.Uuid
  email          String        @unique
  role           Role
  tutorProfileId String?       @map("tutor_profile_id") @db.Uuid
  passwordHash   String?       @map("password_hash")
  isActive       Boolean       @default(true) @map("is_active")
  tutorProfile   TutorProfile? @relation(fields: [tutorProfileId], references: [id])
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @default(now()) @map("updated_at")

  magicLinkTokens MagicLinkToken[]
  approvedSessions Session[]       @relation("approved_by")
  sessionHistoryChanges SessionHistory[] @relation("changed_by")
  invoices        Invoice[]
  adjustmentsCreated Adjustment[] @relation("adjustment_created_by")
  adjustmentsApproved Adjustment[] @relation("adjustment_approved_by")

  @@map("users")
}

model PayPeriod {
  id             String          @id @default(uuid()) @db.Uuid
  periodStartDate DateTime       @map("period_start_date") @db.Date
  periodEndDate   DateTime       @map("period_end_date") @db.Date
  status         PayPeriodStatus @default(OPEN)
  lockedAt       DateTime?       @map("locked_at")
  lockedByUserId String?         @map("locked_by_user_id") @db.Uuid
  notes          String?

  lockedBy User? @relation(fields: [lockedByUserId], references: [id])
  adjustments Adjustment[]

  @@map("pay_periods")
  @@unique([periodStartDate])
}

model Adjustment {
  id               String           @id @default(uuid()) @db.Uuid
  tutorId          String           @map("tutor_id") @db.Uuid
  payPeriodId      String           @map("pay_period_id") @db.Uuid
  type             AdjustmentType
  amount           Decimal          @db.Numeric(10, 2)
  reason           String
  status           AdjustmentStatus @default(APPROVED)
  createdByUserId  String           @map("created_by_user_id") @db.Uuid
  approvedByUserId String?          @map("approved_by_user_id") @db.Uuid
  createdAt        DateTime         @default(now()) @map("created_at")
  approvedAt       DateTime?        @map("approved_at")
  voidedAt         DateTime?        @map("voided_at")
  voidedByUserId   String?          @map("voided_by_user_id") @db.Uuid
  voidReason       String?          @map("void_reason")
  relatedSessionId String?          @map("related_session_id") @db.Uuid

  tutor TutorProfile @relation(fields: [tutorId], references: [id])
  payPeriod PayPeriod @relation(fields: [payPeriodId], references: [id])
  createdBy User @relation("adjustment_created_by", fields: [createdByUserId], references: [id])
  approvedBy User? @relation("adjustment_approved_by", fields: [approvedByUserId], references: [id])
  voidedBy User? @relation(fields: [voidedByUserId], references: [id])
  relatedSession Session? @relation(fields: [relatedSessionId], references: [id])
  invoiceLines InvoiceLine[]

  @@map("adjustments")
  @@index([tutorId, payPeriodId])
  @@index([payPeriodId])
}

model MagicLinkToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id])

  @@map("magic_link_tokens")
  @@index([tokenHash])
}

model AuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  actorUserId   String?  @map("actor_user_id") @db.Uuid
  actorRole     String?  @map("actor_role")
  action        String
  entityType    String?  @map("entity_type")
  entityId      String?  @map("entity_id")
  metaJson      Json?    @map("meta_json")
  ip            String?
  userAgent     String?  @map("user_agent")
  correlationId String?  @map("correlation_id")
  createdAt     DateTime @default(now()) @map("created_at")

  actor User? @relation(fields: [actorUserId], references: [id])

  @@map("audit_log")
  @@index([createdAt(sort: Desc)])
  @@index([actorUserId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
}

model ImpersonationSession {
  id              String   @id @db.Uuid
  adminUserId     String   @map("admin_user_id") @db.Uuid
  tutorId         String   @map("tutor_id") @db.Uuid
  tutorUserId     String   @map("tutor_user_id") @db.Uuid
  sessionHash     String   @map("session_hash")
  mode            String
  expiresAt       DateTime @map("expires_at") @db.Timestamptz
  revokedAt       DateTime? @map("revoked_at") @db.Timestamptz
  revokedByUserId String?  @map("revoked_by_user_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  adminUser User @relation(fields: [adminUserId], references: [id])
  tutor     TutorProfile @relation(fields: [tutorId], references: [id])
  tutorUser User @relation(fields: [tutorUserId], references: [id])
  revokedBy User? @relation(fields: [revokedByUserId], references: [id])

  @@map("impersonation_sessions")
  @@index([adminUserId, createdAt(sort: Desc)])
  @@index([tutorId, createdAt(sort: Desc)])
  @@index([expiresAt])
}

model RetentionEvent {
  id         String   @id @default(uuid()) @db.Uuid
  ranAt      DateTime @default(now()) @map("ran_at") @db.Timestamptz
  configJson Json     @map("config_json")
  cutoffsJson Json    @map("cutoffs_json")
  summaryJson Json    @map("summary_json")

  @@map("retention_events")
  @@index([ranAt(sort: Desc)])
}

model AuthEventLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  ip         String?
  userAgent  String?  @map("user_agent")
  deviceHash String?  @map("device_hash")
  country    String?
  success    Boolean  @default(false)
  riskScore  Int      @default(0) @map("risk_score")
  flagsJson  Json?    @map("flags_json")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User? @relation(fields: [userId], references: [id])

  @@map("auth_event_log")
  @@index([userId, createdAt(sort: Desc)])
  @@index([ip, createdAt(sort: Desc)])
}

model JobQueue {
  id         String   @id @default(uuid()) @db.Uuid
  jobType    String   @map("job_type")
  status     String   @default("PENDING")
  payloadJson Json    @map("payload_json")
  resultJson Json?    @map("result_json")
  errorText  String?  @map("error_text")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  startedAt  DateTime? @map("started_at") @db.Timestamptz
  finishedAt DateTime? @map("finished_at") @db.Timestamptz
  attempts   Int      @default(0)
  maxAttempts Int     @default(3) @map("max_attempts")
  deadLetteredAt DateTime? @map("dead_lettered_at") @db.Timestamptz

  @@map("job_queue")
  @@index([status, createdAt(sort: Asc)])
  @@index([status, attempts, createdAt(sort: Asc)])
}

model TutorProfile {
  id                String  @id @default(uuid()) @db.Uuid
  fullName          String  @map("full_name")
  phone             String?
  defaultHourlyRate Decimal @map("default_hourly_rate") @db.Numeric(10, 2)
  active            Boolean @default(true)
  status            String  @default("ACTIVE")
  qualificationBand String? @map("qualification_band")
  qualifiedSubjects Json?   @map("qualified_subjects_json")

  user        User?
  assignments Assignment[]
  sessions    Session[]
  invoices    Invoice[]

  @@map("tutor_profiles")
}

model Student {
  id            String  @id @default(uuid()) @db.Uuid
  fullName      String  @map("full_name")
  grade         String?
  guardianName  String? @map("guardian_name")
  guardianPhone String? @map("guardian_phone")
  notes         String?
  active        Boolean @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @map("updated_at")

  assignments Assignment[]
  sessions    Session[]

  @@map("students")
}

model Assignment {
  id                   String   @id @default(uuid()) @db.Uuid
  tutorId              String   @map("tutor_id") @db.Uuid
  studentId            String   @map("student_id") @db.Uuid
  subject              String
  startDate            DateTime @map("start_date") @db.Date
  endDate              DateTime? @map("end_date") @db.Date
  rateOverride         Decimal? @map("rate_override") @db.Numeric(10, 2)
  allowedDaysJson      Json     @map("allowed_days_json")
  allowedTimeRangesJson Json    @map("allowed_time_ranges_json")
  active               Boolean  @default(true)

  tutor   TutorProfile @relation(fields: [tutorId], references: [id])
  student Student      @relation(fields: [studentId], references: [id])
  sessions Session[]

  @@map("assignments")
  @@index([tutorId, studentId])
}

model Session {
  id              String        @id @default(uuid()) @db.Uuid
  tutorId         String        @map("tutor_id") @db.Uuid
  studentId       String        @map("student_id") @db.Uuid
  assignmentId    String        @map("assignment_id") @db.Uuid
  date            DateTime      @db.Date
  startTime       DateTime      @map("start_time") @db.Time
  endTime         DateTime      @map("end_time") @db.Time
  durationMinutes Int           @map("duration_minutes")
  mode            String
  location        String?
  notes           String?
  syncKey         String?       @map("sync_key")
  status          SessionStatus @default(DRAFT)
  createdAt       DateTime      @default(now()) @map("created_at")
  submittedAt     DateTime?     @map("submitted_at")
  approvedAt      DateTime?     @map("approved_at")
  approvedById    String?       @map("approved_by") @db.Uuid

  tutor      TutorProfile @relation(fields: [tutorId], references: [id])
  student    Student      @relation(fields: [studentId], references: [id])
  assignment Assignment  @relation(fields: [assignmentId], references: [id])
  approvedBy User?        @relation("approved_by", fields: [approvedById], references: [id])
  history    SessionHistory[]
  invoiceLines InvoiceLine[]

  @@map("sessions")
  @@index([tutorId, date])
}

model SessionHistory {
  id               String   @id @default(uuid()) @db.Uuid
  sessionId        String   @map("session_id") @db.Uuid
  changedByUserId  String?  @map("changed_by_user_id") @db.Uuid
  changeType       String   @map("change_type")
  beforeJson       Json?    @map("before_json")
  afterJson        Json?    @map("after_json")
  createdAt        DateTime @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id])
  changedBy User? @relation("changed_by", fields: [changedByUserId], references: [id])

  @@map("session_history")
  @@index([sessionId])
}

model Invoice {
  id           String        @id @default(uuid()) @db.Uuid
  tutorId      String        @map("tutor_id") @db.Uuid
  periodStart  DateTime      @map("period_start") @db.Date
  periodEnd    DateTime      @map("period_end") @db.Date
  invoiceNumber String       @map("invoice_number")
  totalAmount  Decimal       @map("total_amount") @db.Numeric(12, 2)
  status       InvoiceStatus @default(DRAFT)
  createdAt    DateTime      @default(now()) @map("created_at")

  tutor TutorProfile @relation(fields: [tutorId], references: [id])
  lines InvoiceLine[]

  @@map("invoices")
  @@unique([invoiceNumber])
  @@index([tutorId, periodStart])
}

model InvoiceLine {
  id          String   @id @default(uuid()) @db.Uuid
  invoiceId   String   @map("invoice_id") @db.Uuid
  sessionId   String?  @map("session_id") @db.Uuid
  adjustmentId String? @map("adjustment_id") @db.Uuid
  lineType    InvoiceLineType @default(SESSION) @map("line_type")
  description String
  minutes     Int
  rate        Decimal  @db.Numeric(10, 2)
  amount      Decimal  @db.Numeric(12, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id])
  session Session? @relation(fields: [sessionId], references: [id])
  adjustment Adjustment? @relation(fields: [adjustmentId], references: [id])

  @@map("invoice_lines")
  @@index([invoiceId])
  @@index([sessionId])
  @@index([adjustmentId])
}

model PrivacyRequest {
  id            String                 @id @default(uuid()) @db.Uuid
  requestType   PrivacyRequestType     @map("request_type")
  subjectType   PrivacySubjectType     @map("subject_type")
  subjectId     String                 @map("subject_id") @db.Uuid
  reason        String?
  status        PrivacyRequestStatus   @default(OPEN)
  outcome       PrivacyRequestOutcome?
  createdByUserId String?              @map("created_by_user_id") @db.Uuid
  createdAt     DateTime               @default(now()) @map("created_at")
  closedAt      DateTime?              @map("closed_at")
  closedByUserId String?               @map("closed_by_user_id") @db.Uuid
  closeNote     String?                @map("close_note")

  @@map("privacy_requests")
  @@index([status, createdAt(sort: Desc)])
  @@index([subjectType, subjectId])
}

model ArcadePlayer {
  id        String   @id @default(uuid()) @db.Uuid
  nickname  String?
  createdAt DateTime @default(now()) @map("created_at")

  sessions       ArcadeSession[]
  scores         ArcadeScore[]
  adImpressions  ArcadeAdImpression[]

  @@map("arcade_players")
}

model ArcadeGame {
  id    String @id
  title String

  sessions ArcadeSession[]
  scores   ArcadeScore[]

  @@map("arcade_games")
}

model ArcadeSession {
  id        String   @id @default(uuid()) @db.Uuid
  playerId  String   @map("player_id") @db.Uuid
  gameId    String   @map("game_id")
  startedAt DateTime @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  clientFingerprintHash String? @map("client_fingerprint_hash")

  player ArcadePlayer @relation(fields: [playerId], references: [id])
  game   ArcadeGame   @relation(fields: [gameId], references: [id])

  @@map("arcade_sessions")
  @@index([playerId, startedAt(sort: Desc)])
  @@index([gameId, startedAt(sort: Desc)])
}

model ArcadeScore {
  id        String   @id @default(uuid()) @db.Uuid
  playerId  String   @map("player_id") @db.Uuid
  gameId    String   @map("game_id")
  sessionId String?  @map("session_id") @db.Uuid
  score     Int
  createdAt DateTime @default(now()) @map("created_at")
  isValidated Boolean @default(false) @map("is_validated")

  player ArcadePlayer @relation(fields: [playerId], references: [id])
  game   ArcadeGame   @relation(fields: [gameId], references: [id])
  session ArcadeSession? @relation(fields: [sessionId], references: [id])

  @@map("arcade_scores")
  @@index([gameId, score(sort: Desc), createdAt(sort: Asc)])
  @@index([playerId, createdAt(sort: Desc)])
  @@index([sessionId, createdAt(sort: Desc)])
  @@index([isValidated, gameId, createdAt(sort: Desc)])
}

model ArcadeSessionToken {
  id        String   @id @default(uuid()) @db.Uuid
  sessionId String   @map("session_id") @db.Uuid
  nonce     String
  issuedAt  DateTime @default(now()) @map("issued_at") @db.Timestamptz
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  clientFingerprintHash String? @map("client_fingerprint_hash")
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz
  tokenVersion Int @default(1) @map("token_version")

  session ArcadeSession @relation(fields: [sessionId], references: [id])

  @@map("arcade_session_tokens")
  @@unique([sessionId, nonce])
  @@index([expiresAt])
}

model ArcadeScoreValidation {
  id         String   @id @default(uuid()) @db.Uuid
  scoreId    String?  @map("score_id") @db.Uuid
  sessionId  String?  @map("session_id") @db.Uuid
  playerId   String?  @map("player_id") @db.Uuid
  gameId     String   @map("game_id")
  riskScore  Int      @default(0) @map("risk_score")
  reasonCode String?  @map("reason_code")
  validator  String?
  telemetryJson Json? @map("telemetry_json")
  validatedAt DateTime @default(now()) @map("validated_at") @db.Timestamptz

  score   ArcadeScore? @relation(fields: [scoreId], references: [id])
  session ArcadeSession? @relation(fields: [sessionId], references: [id])
  player  ArcadePlayer? @relation(fields: [playerId], references: [id])

  @@map("arcade_score_validations")
  @@index([sessionId, validatedAt(sort: Desc)])
  @@index([gameId, validatedAt(sort: Desc)])
}

model ArcadeScoreQuarantine {
  id         String   @id @default(uuid()) @db.Uuid
  sessionId  String?  @map("session_id") @db.Uuid
  playerId   String?  @map("player_id") @db.Uuid
  gameId     String   @map("game_id")
  score      Int
  payloadJson Json    @map("payload_json")
  telemetryJson Json? @map("telemetry_json")
  riskScore  Int      @default(0) @map("risk_score")
  reasonCode String?  @map("reason_code")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  session ArcadeSession? @relation(fields: [sessionId], references: [id])
  player  ArcadePlayer? @relation(fields: [playerId], references: [id])

  @@map("arcade_score_quarantine")
  @@index([sessionId, createdAt(sort: Desc)])
}

model ArcadeGameplayEvent {
  eventId   String   @id @map("event_id") @db.Uuid
  eventType String   @map("event_type")
  occurredAt DateTime @map("occurred_at") @db.Timestamptz
  sessionId String?  @map("session_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  anonId    String?  @map("anon_id")
  source    String?
  dedupeKey String   @unique @map("dedupe_key")
  payloadJson Json?  @map("payload_json")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  session ArcadeSession? @relation(fields: [sessionId], references: [id])
  user ArcadePlayer? @relation(fields: [userId], references: [id])

  @@map("arcade_gameplay_events")
  @@index([sessionId, occurredAt(sort: Desc)])
  @@index([eventType, occurredAt(sort: Desc)])
}

model ArcadeAdEvent {
  eventId   String   @id @map("event_id") @db.Uuid
  eventType String   @map("event_type")
  occurredAt DateTime @map("occurred_at") @db.Timestamptz
  sessionId String?  @map("session_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  anonId    String?  @map("anon_id")
  source    String?
  dedupeKey String   @unique @map("dedupe_key")
  placement String?
  provider  String?
  creativeId String? @map("creative_id")
  variantId String? @map("variant_id")
  payloadJson Json?  @map("payload_json")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  session ArcadeSession? @relation(fields: [sessionId], references: [id])
  user ArcadePlayer? @relation(fields: [userId], references: [id])

  @@map("arcade_ad_events")
  @@index([sessionId, occurredAt(sort: Desc)])
  @@index([eventType, occurredAt(sort: Desc)])
  @@index([placement, occurredAt(sort: Desc)])
}

model ArcadeAdProvider {
  provider String @id
  allowedOrigins Json @default("[]") @map("allowed_origins")
  isActive Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("arcade_ad_providers")
}

model ArcadeAdBlocklist {
  id         String   @id @default(uuid()) @db.Uuid
  provider   String
  creativeId String   @map("creative_id")
  reason     String
  blockedAt  DateTime @default(now()) @map("blocked_at") @db.Timestamptz
  lastSeenAt DateTime @default(now()) @map("last_seen_at") @db.Timestamptz
  seenCount  Int      @default(1) @map("seen_count")

  @@map("arcade_ad_blocklist")
  @@unique([provider, creativeId])
}

model ArcadeReconciliationReport {
  id         String   @id @default(uuid()) @db.Uuid
  reportJson Json     @map("report_json")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("arcade_reconciliation_reports")
}

model ArcadeAdImpression {
  id        String   @id @default(uuid()) @db.Uuid
  playerId  String   @map("player_id") @db.Uuid
  placement String
  createdAt DateTime @default(now()) @map("created_at")

  player ArcadePlayer @relation(fields: [playerId], references: [id])

  @@map("arcade_ad_impressions")
  @@index([playerId, placement, createdAt(sort: Desc)])
}

model ArcadeAdRule {
  placement       String @id
  cooldownSeconds Int    @map("cooldown_seconds")
  maxPerDay       Int    @map("max_per_day")

  @@map("arcade_ad_rules")
}
